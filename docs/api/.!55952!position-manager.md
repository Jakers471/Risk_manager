# Position Manager API

Comprehensive async position tracking, portfolio management, and performance analytics with real-time monitoring.

## Overview

The PositionManager provides complete position tracking capabilities including real-time updates, performance analytics, risk monitoring, and portfolio management with full async support.


## Quick Start

```python
from project_x_py import TradingSuite

async def basic_position_management():
    suite = await TradingSuite.create("MNQ")

    # Access the integrated position manager
    positions = suite.positions

    # Get current position
    position = await positions.get_position("MNQ")
    if position:
        print(f"Size: {position.size}")
        print(f"Avg Price: ${position.avg_price:.2f}")
        print(f"Unrealized PnL: ${position.unrealized_pnl:.2f}")

    await suite.disconnect()
```

## Position Tracking

### Current Positions

```python
async def current_positions():
    suite = await TradingSuite.create("MNQ")

    # Get specific position
    mnq_position = await suite.positions.get_position("MNQ")
    if mnq_position:
        print(f"MNQ Position:")
        print(f"  Size: {mnq_position.size}")
        print(f"  Side: {'Long' if mnq_position.size > 0 else 'Short'}")
        print(f"  Average Price: ${mnq_position.avg_price:.2f}")
        print(f"  Market Value: ${mnq_position.market_value:.2f}")
        print(f"  Unrealized PnL: ${mnq_position.unrealized_pnl:.2f}")
        print(f"  Realized PnL: ${mnq_position.realized_pnl:.2f}")

    # Get all positions
    all_positions = await suite.positions.get_all_positions()
    for instrument, position in all_positions.items():
        print(f"{instrument}: {position.size} @ ${position.avg_price:.2f}")

    await suite.disconnect()
```

### Position Details

```python
async def position_details():
    suite = await TradingSuite.create("MNQ")

    position = await suite.positions.get_position("MNQ")
    if position:
        # Basic information
        print(f"Instrument: {position.instrument}")
        print(f"Size: {position.size}")
        print(f"Average Price: ${position.avg_price:.2f}")

        # P&L information
        print(f"Unrealized PnL: ${position.unrealized_pnl:.2f}")
        print(f"Realized PnL: ${position.realized_pnl:.2f}")
        print(f"Total PnL: ${position.total_pnl:.2f}")

        # Market information
        print(f"Current Price: ${position.current_price:.2f}")
        print(f"Market Value: ${position.market_value:.2f}")

        # Risk metrics
        print(f"Position Value: ${position.position_value:.2f}")
        print(f"Max Drawdown: ${position.max_drawdown:.2f}")

        # Timestamps
        print(f"Opened: {position.open_time}")
        print(f"Last Updated: {position.last_update}")

    await suite.disconnect()
```

## Portfolio Management

### Portfolio Overview

```python
async def portfolio_overview():
    suite = await TradingSuite.create("MNQ")

    # Get comprehensive portfolio metrics
    portfolio_metrics = await suite.positions.get_portfolio_metrics()

    print("Portfolio Overview:")
    print(f"  Total Value: ${portfolio_metrics['total_portfolio_value']:,.2f}")
    print(f"  Total PnL: ${portfolio_metrics['total_pnl']:,.2f}")
    print(f"  Unrealized PnL: ${portfolio_metrics['unrealized_pnl']:,.2f}")
    print(f"  Realized PnL: ${portfolio_metrics['realized_pnl']:,.2f}")
    print(f"  Number of Positions: {portfolio_metrics['position_count']}")

    # Performance metrics
    performance = portfolio_metrics.get('performance', {})
    print("\nPerformance Metrics:")
    print(f"  Return: {performance.get('return_percentage', 0):.2f}%")
    print(f"  Sharpe Ratio: {performance.get('sharpe_ratio', 0):.2f}")
    print(f"  Max Drawdown: {performance.get('max_drawdown_percentage', 0):.2f}%")
    print(f"  Win Rate: {performance.get('win_rate', 0):.1f}%")

    await suite.disconnect()
```

### Risk Metrics

```python
async def risk_metrics():
    suite = await TradingSuite.create("MNQ")

    # Get risk analysis
    risk_analysis = await suite.positions.get_risk_analysis()

    print("Risk Analysis:")
    print(f"  Portfolio Beta: {risk_analysis.get('beta', 0):.2f}")
    print(f"  Value at Risk (95%): ${risk_analysis.get('var_95', 0):,.2f}")
    print(f"  Expected Shortfall: ${risk_analysis.get('expected_shortfall', 0):,.2f}")
    print(f"  Maximum Position Size: {risk_analysis.get('max_position_size', 0)}")

    # Position concentration
    concentration = risk_analysis.get('concentration', {})
    print("\nPosition Concentration:")
    for instrument, percentage in concentration.items():
        print(f"  {instrument}: {percentage:.1f}%")

    await suite.disconnect()
```

## Performance Analytics

### Trade Analytics


```python
async def trade_analytics():
    suite = await TradingSuite.create("MNQ")

    # Get detailed analytics
    analytics = await suite.positions.get_analytics()

    print("Trade Analytics:")
    print(f"  Total Trades: {analytics['total_trades']}")
    print(f"  Winning Trades: {analytics['winning_trades']}")
    print(f"  Losing Trades: {analytics['losing_trades']}")
    print(f"  Win Rate: {analytics['win_rate']:.1f}%")

    print(f"\nProfit/Loss:")
    print(f"  Average Win: ${analytics['avg_winning_trade']:,.2f}")
    print(f"  Average Loss: ${analytics['avg_losing_trade']:,.2f}")
    print(f"  Largest Win: ${analytics['largest_winning_trade']:,.2f}")
    print(f"  Largest Loss: ${analytics['largest_losing_trade']:,.2f}")
    print(f"  Profit Factor: {analytics['profit_factor']:.2f}")

    print(f"\nTrade Duration:")
    print(f"  Average Hold Time: {analytics['avg_hold_time_hours']:.1f} hours")
    print(f"  Shortest Trade: {analytics['shortest_trade_minutes']:.0f} minutes")
    print(f"  Longest Trade: {analytics['longest_trade_hours']:.1f} hours")

    await suite.disconnect()
```

### Performance Tracking

```python
async def performance_tracking():
    suite = await TradingSuite.create("MNQ")

    # Track performance over time
    performance_history = await suite.positions.get_performance_history(
        days=30  # Last 30 days
    )

    for date, metrics in performance_history.items():
        print(f"{date}: PnL ${metrics['daily_pnl']:,.2f}, "
              f"Return {metrics['daily_return']:.2f}%")

    # Monthly performance summary
    monthly_performance = await suite.positions.get_monthly_performance()
    for month, stats in monthly_performance.items():
        print(f"{month}: ${stats['total_pnl']:,.2f} "
              f"({stats['return_percentage']:+.1f}%)")

    await suite.disconnect()
```

## Real-time Monitoring

### Position Updates

```python
from project_x_py import EventType

async def position_monitoring():
    suite = await TradingSuite.create("MNQ", timeframes=["1min"])

    # Real-time position update handler
    async def on_position_changed(event):
        position = event.data
        print(f"Position Update - {position.instrument}:")
        print(f"  Size: {position.size}")
        print(f"  Unrealized PnL: ${position.unrealized_pnl:.2f}")
        print(f"  Current Price: ${position.current_price:.2f}")

    # Register for position events
    await suite.on(EventType.POSITION_CHANGED, on_position_changed)

    # Keep monitoring
    await asyncio.sleep(300)  # Monitor for 5 minutes
    await suite.disconnect()
```

### P&L Alerts

```python
async def pnl_alerts():
    suite = await TradingSuite.create("MNQ")

    # Set up P&L monitoring
    async def monitor_pnl():
        while True:
            portfolio_metrics = await suite.positions.get_portfolio_metrics()
            unrealized_pnl = portfolio_metrics.get('unrealized_pnl', 0)

            # Alert thresholds
            if unrealized_pnl < -500:  # $500 loss
