# Risk Management Guide

Risk management is crucial for successful trading. The ProjectX SDK provides comprehensive risk management tools through the RiskManager component and ManagedTrade class to help protect your capital and automate risk-based position sizing.

## Overview

The SDK's risk management system provides:

- **Position sizing** based on risk amount and stop distance
- **Account-level risk limits** (daily loss, drawdown, position size)
- **Real-time risk monitoring** with automatic alerts
- **ManagedTrade** for automated risk-controlled order execution
- **Risk metrics calculation** (VaR, Sharpe ratio, max drawdown)
- **Integration** with all trading components

## Getting Started

### Enable Risk Manager

```python
from project_x_py import TradingSuite, Features

async def basic_risk_setup():
    # Enable risk manager feature
    suite = await TradingSuite.create(
        "MNQ",
        features=[Features.RISK_MANAGER]
    )

    # Check if risk manager is available
    if suite.risk_manager:
        print("Risk Manager enabled")

        # Get current risk limits
        limits = await suite.risk_manager.get_limits()
        print(f"Max position size: {limits.max_position_size}")
        print(f"Max daily loss: ${limits.max_daily_loss:.2f}")

    await suite.disconnect()
```

### Basic Risk Configuration

```python
from project_x_py.risk_manager import RiskConfig

async def configure_risk():
    # Define risk parameters
    risk_config = RiskConfig(
        max_position_size=5,           # Max 5 contracts
        max_daily_loss=1000.0,         # Max $1000 daily loss
        max_drawdown_percent=10.0,     # Max 10% drawdown
        position_size_percent=2.0,     # 2% of account per trade
        stop_loss_percent=1.0,         # 1% stop loss
        risk_reward_ratio=2.0          # 1:2 risk/reward
    )

    suite = await TradingSuite.create(
        "MNQ",
        features=["risk_manager"],
        risk_config=risk_config
    )

    await suite.disconnect()
```

## Position Sizing

### Risk-Based Position Sizing

```python
async def risk_based_sizing():
    suite = await TradingSuite.create("MNQ", features=["risk_manager"])

    if suite.risk_manager:
        # Calculate position size based on risk amount
        position_size = await suite.risk_manager.calculate_position_size(
            risk_amount=200.0,      # Risk $200 per trade
            entry_price=21050.0,    # Entry price
            stop_price=21025.0,     # Stop loss price
            contract_size=20        # MNQ contract size ($20/point)
        )

        print(f"Recommended position size: {position_size} contracts")

        # Alternative: Calculate based on account percentage
        account_size = await suite.risk_manager.get_account_size()
        risk_amount_pct = account_size * 0.02  # 2% of account

        position_size_pct = await suite.risk_manager.calculate_position_size(
            risk_amount=risk_amount_pct,
            entry_price=21050.0,
            stop_price=21025.0,
            contract_size=20
        )

        print(f"Position size (2% risk): {position_size_pct} contracts")

    await suite.disconnect()
```

### ATR-Based Position Sizing

```python
from project_x_py.indicators import ATR

async def atr_based_sizing():
    suite = await TradingSuite.create("MNQ", features=["risk_manager"], timeframes=["5min"])

    # Get recent data and calculate ATR
    bars = await suite.data.get_data("5min", count=100)
    data_with_atr = bars.pipe(ATR, period=14)

    current_atr = data_with_atr.tail(1)["atr_14"].item()
    current_price = await suite.data.get_current_price()

    if suite.risk_manager:
        # Use 2x ATR as stop distance
        stop_distance = current_atr * 2
        stop_price = current_price - stop_distance  # For long position

        # Calculate position size
        position_size = await suite.risk_manager.calculate_position_size(
            risk_amount=250.0,
            entry_price=current_price,
            stop_price=stop_price,
            contract_size=20
        )

        print(f"Current ATR: {current_atr:.2f}")
        print(f"Stop distance: {stop_distance:.2f}")
        print(f"Position size: {position_size} contracts")

    await suite.disconnect()
```

## ManagedTrade

The ManagedTrade class provides automated risk-controlled trading with built-in position sizing and risk management.

### Basic ManagedTrade

```python
from project_x_py.risk_manager import ManagedTrade

async def basic_managed_trade():
    suite = await TradingSuite.create("MNQ", features=["risk_manager"])

    # Create a managed trade with risk parameters
    managed_trade = ManagedTrade(
        suite=suite,
        max_risk_per_trade=200.0,    # Risk $200 per trade
        risk_reward_ratio=2.0,       # 1:2 risk/reward
        max_position_size=3          # Max 3 contracts
    )

    # Execute trade with automatic risk management
    result = await managed_trade.execute_trade(
        side=0,  # Buy
        entry_signal="RSI oversold + support bounce",
        stop_loss_type="atr",        # ATR-based stop
        take_profit_type="fixed"     # Fixed profit target
    )

    if result.success:
        print(f"Trade executed successfully:")
        print(f"  Entry Order: {result.main_order_id}")
        print(f"  Stop Loss: {result.stop_order_id}")
        print(f"  Take Profit: {result.target_order_id}")
        print(f"  Position Size: {result.position_size}")
        print(f"  Risk Amount: ${result.risk_amount:.2f}")
    else:
        print(f"Trade rejected: {result.error}")

    await suite.disconnect()
```

### Advanced ManagedTrade

```python
async def advanced_managed_trade():
    suite = await TradingSuite.create("MNQ", features=["risk_manager"], timeframes=["5min"])

    # Advanced managed trade configuration
    managed_trade = ManagedTrade(
        suite=suite,
        max_risk_per_trade=300.0,
        risk_reward_ratio=2.5,
        max_position_size=5,
        use_trailing_stop=True,      # Enable trailing stop
        trailing_stop_distance=1.5,  # 1.5x ATR trailing distance
        partial_profit_levels=[      # Take partial profits
            {"percentage": 0.5, "at_reward_ratio": 1.0},  # 50% at 1:1
            {"percentage": 0.3, "at_reward_ratio": 1.5}   # 30% at 1.5:1
        ]
    )

    # Execute with custom parameters
    result = await managed_trade.execute_trade(
        side=0,  # Buy
        entry_signal="Breakout above resistance",
        entry_type="limit",          # Use limit order for entry
        entry_price=21075.0,         # Specific entry price
        stop_loss_type="percentage", # Percentage-based stop
        stop_loss_percentage=1.2,    # 1.2% stop loss
        take_profit_type="multiple", # Multiple profit targets
        profit_targets=[21150.0, 21200.0, 21250.0],
        time_in_force="DAY"         # Day order
    )

    if result.success:
        print(f"Advanced trade executed:")
        print(f"  Position Size: {result.position_size} contracts")
        print(f"  Entry Price: ${result.entry_price:.2f}")
        print(f"  Stop Loss: ${result.stop_loss_price:.2f}")
        print(f"  Profit Targets: {[f'${p:.2f}' for p in result.profit_targets]}")

    await suite.disconnect()
```

## Risk Limits and Monitoring

### Setting Risk Limits

```python
async def set_risk_limits():
    suite = await TradingSuite.create("MNQ", features=["risk_manager"])

    if suite.risk_manager:
        # Set account-level risk limits
        await suite.risk_manager.set_limits(
            max_position_size=10,        # Max position size
            max_daily_loss=2000.0,       # Max daily loss
            max_drawdown_percent=15.0,   # Max drawdown percentage
            max_correlation=0.7,         # Max position correlation
            max_sector_exposure=50.0,    # Max sector exposure %
            risk_per_trade_percent=2.0   # Max risk per trade
        )

        # Set instrument-specific limits
        await suite.risk_manager.set_instrument_limits(
            instrument="MNQ",
            max_position=5,              # Max MNQ position
            max_daily_trades=20,         # Max trades per day
            max_trade_size=3             # Max single trade size
        )

        print("Risk limits updated")

    await suite.disconnect()
```

### Real-time Risk Monitoring

```python
from project_x_py import EventType

async def real_time_risk_monitoring():
    suite = await TradingSuite.create("MNQ", features=["risk_manager"])

    # Risk event handlers
    async def on_risk_limit_exceeded(event):
